tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://baltig.infn.it/infn-cloud/tosca-types/raw/master/custom_types.yaml

description: Run a single VM with all the CYGNO envirnoment exposing both ssh access and Jupyter

metadata:
  display_name: Working Station for CYGNO experiment
  icon: https://paas.cloud.infn.it/public/images/cygno.png
  allowed_groups: "beta-testers,developers,orchestrator-admin"

topology_template:

  inputs:

    num_cpus:
      type: integer
      description: "Number of VM vCPUs [int]"
      default: 4
    mem_size:
      type: string
      description: "VM Memory size [str]"
      default: "4 GB"
    jupyter_token:
      required: yes
      type: string
      description: "Token for Jupyter login [str]"
      
  node_templates:

    cygno_basic:
      type: tosca.nodes.DODAS.cygno
      properties:
        cygno_user: "cloudadm"
        jupyter_port: 8888
        jupyter_token: { get_input: jupyter_token }
      requirements:
        - host: cygno_server
        - dependency: pip_manager_install

#      type: tosca.nodes.DODAS.pip_manager_cygno
    pip_manager_install:
      type: tosca.nodes.DODAS.pip_manager
      properties:
        packages: 
          - name: cycler
            version: "0.10.0"
          - name: decorator
            version: "4.4.0"
          - name: imageio
            version: "2.6.1"
          - name: joblib
            version: "0.14.0"
          - name: kiwisolver
            version: "1.1.0"
          - name: matplotlib
            version: "3.1.1"
          - name: networkx
            version: "'2.4'"
          - name: numpy
            version: "1.17.3"
          - name: Pillow
            version: "6.2.0"
          - name: pyparsing
            version: "2.4.2"
          - name: python-dateutil
            version: "2.8.0"
          - name: PyWavelets
            version: "1.1.0"
          - name: root-numpy
            version: "4.8.0"
          - name: scikit-image
            version: "0.16.1"
          - name: scikit-learn
            version: "0.21.3"
          - name: scipy
            version: "1.3.1"
          - name: six
            version: "1.12.0"
          - name: metakernel 
          - name: zmq   
          - name: pandas
          - name: seaborn
          - name: python-swiftclient
          - name: keystoneauth1
          - name: h5py
          - name: jupyter  
      requirements:
        - host: cygno_server
        - dependency: root_cern_install

    root_cern_install:
      type: tosca.nodes.DODAS.root_cern
      properties:
        centos_url: https://cernbox.cern.ch/remote.php/webdav/root_v6.20.04.Linux-centos7-x86_64-gcc4.8.tar.gz?x-access-token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhY2NvdW50X2lkIjoic3BpZ2EiLCJncm91cHMiOltdLCJkaXNwbGF5X25hbWUiOiJEYW5pZWxlIFNwaWdhIChzcGlnYSkifQ.Id_4goGf9qJh0HPDZMgd4kn5ZgobeqAPv-Yuh79_vj8
      requirements:
        - host: cygno_server

    cygno_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        endpoint:
          properties:
            network_name: PUBLIC
            ports:
              jupyter:
                protocol: tcp
                source: 8888
        scalable:
          properties:
            count: 1
        host:
          properties:
            num_cpus: { get_input: num_cpus }
            mem_size: { get_input: mem_size }
        os:
          properties:
            distribution: centos
            version: 7

  outputs:
    label:
      value: "CYGNO Experiment working station"
    node_ip:
      value: { get_attribute: [ cygno_server, public_address, 0 ] }
    node_creds:
      value: { get_attribute: [ cygno_server, endpoint, credential, 0 ] }
    jupyter_endpoint:
      value: { concat: [ 'http://', get_attribute: [ cygno_server, public_address, 0 ],":8888" ]}
